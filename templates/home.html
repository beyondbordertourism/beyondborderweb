{% extends "base.html" %}

{% block title %}Here. - Your Next Destination Awaits{% endblock %}

{% block content %}
<div class="hero-klook">
    <div class="hero-klook-left">
        <div class="city-carousel">
            <!-- Countries will be loaded dynamically -->
        </div>
    </div>
    <div class="hero-klook-right">
        <div class="search-and-filter-klook">
            <form action="/search" method="GET" class="search-box-klook" autocomplete="off">
                <i class="fas fa-search"></i>
                <input type="text" name="q" id="search-input" placeholder="Search for a country...">
                <button type="submit" class="search-button-klook">Search</button>
            </form>
            <div id="search-results-klook" class="search-results-klook"></div>
            <div class="filter-buttons-klook">
                <button><i class="fas fa-file-alt"></i> Visa Application</button>
                <button><i class="fas fa-check-circle"></i> Document Check</button>
                <button><i class="fas fa-globe-americas"></i> E-Visa Services</button>
            </div>
        </div>
    </div>
</div>

<!-- Featured Countries Section -->
<section class="py-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold text-gray-900 sm:text-4xl">Popular Destinations</h2>
            <p class="mt-4 text-lg text-gray-600">Discover visa requirements for the most sought-after travel destinations</p>
        </div>
        
        <!-- Loading State -->
        <div id="featuredLoadingState" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            <p class="mt-4 text-gray-600">Loading destinations...</p>
        </div>
        
        <!-- Featured Countries Grid -->
        <div id="featuredCountriesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" style="display: none;">
            <!-- Featured countries will be loaded here -->
        </div>
        
        <!-- View All Button -->
        <div class="text-center mt-12">
            <a href="/countries" class="inline-flex items-center gap-2 bg-indigo-600 text-white px-8 py-3 rounded-lg hover:bg-indigo-700 transition-colors font-medium">
                View All Countries
                <i class="fas fa-arrow-right"></i>
            </a>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load carousel config and initialize
    fetch('/static/js/carousel-config.json')
        .then(response => response.json())
        .then(config => {
            initializeCarousel(config);
        })
        .catch(error => {
            console.error('Error loading carousel config:', error);
            // Fallback to default config
            const defaultConfig = {
                countries: [
                    {
                        name: "Japan",
                        backgroundImage: "https://images.unsplash.com/photo-1508179499299-2643424fae56?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                    },
                    {
                        name: "Singapore",
                        backgroundImage: "https://images.unsplash.com/photo-1657445003648-aa6ed5fc5d63?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                    },
                    {
                        name: "South Korea",
                        backgroundImage: "https://images.unsplash.com/photo-1551685314-8167cf1cba72?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                    },
                    {
                        name: "Thailand",
                        backgroundImage: "https://plus.unsplash.com/premium_photo-1707793862259-78c4112475d1?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                    },
                    {
                        name: "Vietnam",
                        backgroundImage: "https://images.unsplash.com/photo-1560979724-f86caa17a2ed?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                    }
                ]
            };
            initializeCarousel(defaultConfig);
        });
    
    // Load featured countries
    loadFeaturedCountries();
});

// Enhanced Country Card Function (same as countries.html)
function createCountryCard(country) {
    const countryId = country.id;  // Always use id
    
    if (!countryId) {
        console.error('Country missing ID:', country);
        return '';  // Skip this country
    }
    
    return `
        <a href="/countries/${countryId}" class="country-card">
            <div class="country-card-content">
                <div class="country-flag-container">
                    <span class="country-flag">${country.flag}</span>
                </div>
                
                <h3 class="country-title">${country.name}</h3>
                <p class="country-region">${country.region}</p>
                
                <p class="country-summary">${country.summary}</p>
                
                <div class="country-card-footer">
                    <span class="visa-status-badge ${country.visa_required ? 'visa-status-required' : 'visa-status-free'}">
                        <i class="fas ${country.visa_required ? 'fa-passport' : 'fa-check-circle'}"></i>
                        ${country.visa_required ? 'Visa Required' : 'Visa Free'}
                    </span>
                    
                    <span class="learn-more-button">
                        Learn More
                        <i class="fas fa-arrow-right learn-more-arrow"></i>
                    </span>
                </div>
                
                ${country.visa_types && country.visa_types.length > 0 ? `
                    <div class="visa-types-preview">
                        ${country.visa_types.slice(0, 2).map(visa => `
                            <span class="visa-type-tag">${visa.name}</span>
                        `).join('')}
                        ${country.visa_types.length > 2 ? `
                            <span class="more-types-indicator">+${country.visa_types.length - 2} more</span>
                        ` : ''}
                    </div>
                ` : ''}
            </div>
        </a>
    `;
}

// Load Featured Countries
async function loadFeaturedCountries() {
    try {
        const response = await fetch('/api/countries/featured?limit=6');
        const featuredCountries = await response.json();
        
        const loadingState = document.getElementById('featuredLoadingState');
        const gridContainer = document.getElementById('featuredCountriesGrid');
        
        loadingState.style.display = 'none';
        
        if (featuredCountries.length > 0) {
            gridContainer.innerHTML = featuredCountries.map(country => createCountryCard(country)).join('');
            gridContainer.style.display = 'grid';
        } else {
            // Fallback to regular countries if no featured countries
            const fallbackResponse = await fetch('/api/countries/?limit=6');
            const fallbackCountries = await fallbackResponse.json();
            gridContainer.innerHTML = fallbackCountries.map(country => createCountryCard(country)).join('');
            gridContainer.style.display = 'grid';
        }
        
    } catch (error) {
        console.error('Error loading featured countries:', error);
        const loadingState = document.getElementById('featuredLoadingState');
        loadingState.innerHTML = `
            <div class="text-center">
                <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Error Loading Countries</h3>
                <p class="text-gray-600">Please try refreshing the page.</p>
            </div>
        `;
    }
}

function initializeCarousel(config) {
    const hero = document.querySelector('.hero-klook');
    const carousel = document.querySelector('.city-carousel');
    let currentIndex = 0;
    let autoSlideInterval;
    let isUserInteracting = false;

    // Create city items from config
    carousel.innerHTML = config.countries.map((country, index) => 
        `<div class="city-item ${index === 0 ? 'active' : ''}" data-city="${country.name}" data-bg="${country.backgroundImage}">${country.name}</div>`
    ).join('');

    const cityItems = document.querySelectorAll('.city-item');

    // Set initial background
    const initialBg = cityItems[currentIndex].getAttribute('data-bg');
    hero.style.backgroundImage = `url('${initialBg}')`;

    // --- Auto Carousel Functionality ---
    function startAutoSlide() {
        autoSlideInterval = setInterval(() => {
            if (!isUserInteracting) {
                const nextIndex = (currentIndex + 1) % cityItems.length;
                setActiveCity(nextIndex);
            }
        }, 3000); // 3 seconds
    }

    function stopAutoSlide() {
        if (autoSlideInterval) {
            clearInterval(autoSlideInterval);
        }
    }

    function resetAutoSlide() {
        stopAutoSlide();
        setTimeout(() => {
            if (!isUserInteracting) {
                startAutoSlide();
            }
        }, 2000); // Wait 2 seconds after user interaction before resuming auto-slide
    }

    // --- Live Search ---
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results-klook');
    let debounceTimer;

    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value;

        if (query.length < 2) {
            searchResults.style.display = 'none';
            return;
        }

        searchResults.innerHTML = `
            <div class="search-result-item">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <div>
                    <strong>Searching...</strong>
                    <p>Finding countries matching "${query}"</p>
                </div>
            </div>
        `;
        searchResults.style.display = 'block';

        debounceTimer = setTimeout(() => {
            fetch(`/api/countries/search?q=${query}&limit=20`)
                .then(response => response.json())
                .then(data => {
                    searchResults.innerHTML = '';
                    if (data.length > 0) {
                        data.slice(0, 4).forEach(country => {
                            const item = document.createElement('a');
                            item.href = `/countries/${country.id}`;
                            item.classList.add('search-result-item');
                            item.innerHTML = `
                                <div class="flag">${country.flag}</div>
                                <div>
                                    <strong>${country.name}</strong>
                                    <p>${country.summary.length > 80 ? country.summary.substring(0, 80) + '...' : country.summary}</p>
                                </div>
                            `;
                            searchResults.appendChild(item);
                        });
                        
                        if (data.length > 4) {
                            const seeAllItem = document.createElement('a');
                            seeAllItem.href = `/search?q=${encodeURIComponent(query)}`;
                            seeAllItem.classList.add('search-result-item', 'see-all-results');
                            seeAllItem.innerHTML = `
                                <div class="see-all-icon">
                                    <i class="fas fa-search"></i>
                                </div>
                                <div>
                                    <strong>See all results for "${query}"</strong>
                                    <p>View all ${data.length}+ countries matching your search</p>
                                </div>
                            `;
                            searchResults.appendChild(seeAllItem);
                        }
                        
                        searchResults.style.display = 'block';
                    } else {
                        const noResultsItem = document.createElement('div');
                        noResultsItem.classList.add('search-result-item', 'no-results');
                        noResultsItem.innerHTML = `
                            <div class="no-results-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <div>
                                <strong>No countries found</strong>
                                <p>Try adjusting your search terms</p>
                            </div>
                        `;
                        searchResults.appendChild(noResultsItem);
                        searchResults.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Search error:', error);
                    searchResults.style.display = 'none';
                });
        }, 300);
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-box-klook')) {
            searchResults.style.display = 'none';
        }
    });

    // --- City click functionality ---
    cityItems.forEach((item, index) => {
        item.addEventListener('click', function() {
            isUserInteracting = true;
            setActiveCity(index);
            resetAutoSlide();
            setTimeout(() => {
                isUserInteracting = false;
            }, 1000);
        });
    });

    function setActiveCity(index) {
        cityItems[currentIndex].classList.remove('active');
        cityItems[currentIndex].classList.add('distant');

        currentIndex = index;
        const targetBg = cityItems[currentIndex].getAttribute('data-bg');
        hero.style.backgroundImage = `url('${targetBg}')`;

        cityItems.forEach((item, i) => {
            item.classList.remove('active', 'semi-active', 'distant');
            if (i === currentIndex) {
                item.classList.add('active');
            } else if (Math.abs(i - currentIndex) === 1 || 
                       (currentIndex === 0 && i === cityItems.length - 1) ||
                       (currentIndex === cityItems.length - 1 && i === 0)) {
                item.classList.add('semi-active');
            } else {
                item.classList.add('distant');
            }
        });
    }

    // Start auto-slide
    startAutoSlide();

    // Handle hover interactions
    carousel.addEventListener('mouseenter', () => {
        isUserInteracting = true;
        stopAutoSlide();
    });

    carousel.addEventListener('mouseleave', () => {
        isUserInteracting = false;
        resetAutoSlide();
    });
}
</script>
{% endblock %}
