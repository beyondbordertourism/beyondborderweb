{% extends "base.html" %}

{% block title %}Here. - Your Next Destination Awaits{% endblock %}

{% block content %}
<div class="hero-klook">
    <div class="hero-klook-left">
        <div class="city-carousel">
            <!-- Countries will be loaded dynamically -->
        </div>
    </div>
    <div class="hero-klook-right">
        <div class="search-and-filter-klook">
            <form action="/search" method="GET" class="search-box-klook" autocomplete="off">
                <i class="fas fa-search"></i>
                <input type="text" name="q" id="search-input" placeholder="Search for a country...">
                <button type="submit" class="search-button-klook">Search</button>
            </form>
            <div id="search-results-klook" class="search-results-klook"></div>
            <div class="filter-buttons-klook">
                <button><i class="fas fa-file-alt"></i> Visa Application</button>
                <button><i class="fas fa-check-circle"></i> Document Check</button>
                <button><i class="fas fa-globe-americas"></i> E-Visa Services</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load carousel config and initialize
    fetch('/static/js/carousel-config.json')
        .then(response => response.json())
        .then(config => {
            initializeCarousel(config);
        })
        .catch(error => {
            console.error('Error loading carousel config:', error);
            // Fallback to default config
            const defaultConfig = {
                countries: [
                    {
                        name: "Japan",
                        backgroundImage: "https://images.unsplash.com/photo-1508179499299-2643424fae56?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                    },
                    {
                        name: "Singapore",
                        backgroundImage: "https://images.unsplash.com/photo-1657445003648-aa6ed5fc5d63?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                    },
                    {
                        name: "South Korea",
                        backgroundImage: "https://images.unsplash.com/photo-1551685314-8167cf1cba72?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                    },
                    {
                        name: "Thailand",
                        backgroundImage: "https://plus.unsplash.com/premium_photo-1707793862259-78c4112475d1?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                    },
                    {
                        name: "Vietnam",
                        backgroundImage: "https://images.unsplash.com/photo-1560979724-f86caa17a2ed?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                    }
                ]
            };
            initializeCarousel(defaultConfig);
        });
});

function initializeCarousel(config) {
    const hero = document.querySelector('.hero-klook');
    const carousel = document.querySelector('.city-carousel');
    let currentIndex = 0;
    let autoSlideInterval;
    let isUserInteracting = false;

    // Create city items from config
    carousel.innerHTML = config.countries.map((country, index) => 
        `<div class="city-item ${index === 0 ? 'active' : ''}" data-city="${country.name}" data-bg="${country.backgroundImage}">${country.name}</div>`
    ).join('');

    const cityItems = document.querySelectorAll('.city-item');

    // Set initial background
    const initialBg = cityItems[currentIndex].getAttribute('data-bg');
    hero.style.backgroundImage = `url('${initialBg}')`;

    // --- Auto Carousel Functionality ---
    function startAutoSlide() {
        autoSlideInterval = setInterval(() => {
            if (!isUserInteracting) {
                const nextIndex = (currentIndex + 1) % cityItems.length;
                setActiveCity(nextIndex);
            }
        }, 3000); // 3 seconds
    }

    function stopAutoSlide() {
        if (autoSlideInterval) {
            clearInterval(autoSlideInterval);
        }
    }

    function resetAutoSlide() {
        stopAutoSlide();
        setTimeout(() => {
            if (!isUserInteracting) {
                startAutoSlide();
            }
        }, 2000); // Wait 2 seconds after user interaction before resuming auto-slide
    }

    // --- Live Search ---
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results-klook');
    let debounceTimer;

    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value;

        if (query.length < 2) {
            searchResults.style.display = 'none';
            return;
        }

        searchResults.innerHTML = `
            <div class="search-result-item">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <div>
                    <strong>Searching...</strong>
                    <p>Finding countries matching "${query}"</p>
                </div>
            </div>
        `;
        searchResults.style.display = 'block';

        debounceTimer = setTimeout(() => {
            fetch(`/api/countries/search?q=${query}&limit=20`)
                .then(response => response.json())
                .then(data => {
                    searchResults.innerHTML = '';
                    if (data.length > 0) {
                        data.slice(0, 4).forEach(country => {
                            const item = document.createElement('a');
                            item.href = `/countries/${country.id}`;
                            item.classList.add('search-result-item');
                            item.innerHTML = `
                                <div class="flag">${country.flag}</div>
                                <div>
                                    <strong>${country.name}</strong>
                                    <p>${country.summary.length > 80 ? country.summary.substring(0, 80) + '...' : country.summary}</p>
                                </div>
                            `;
                            searchResults.appendChild(item);
                        });
                        
                        if (data.length > 4) {
                            const seeAllItem = document.createElement('a');
                            seeAllItem.href = `/search?q=${encodeURIComponent(query)}`;
                            seeAllItem.classList.add('search-result-item', 'see-all-results');
                            seeAllItem.innerHTML = `
                                <div class="see-all-icon">
                                    <i class="fas fa-search"></i>
                                </div>
                                <div>
                                    <strong>See all results for "${query}"</strong>
                                    <p>View all ${data.length}+ countries matching your search</p>
                                </div>
                            `;
                            searchResults.appendChild(seeAllItem);
                        }
                        
                        searchResults.style.display = 'block';
                    } else {
                        const noResultsItem = document.createElement('div');
                        noResultsItem.classList.add('search-result-item', 'no-results');
                        noResultsItem.innerHTML = `
                            <div class="no-results-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <div>
                                <strong>No countries found</strong>
                                <p>Try adjusting your search terms</p>
                            </div>
                        `;
                        searchResults.appendChild(noResultsItem);
                        searchResults.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Search error:', error);
                    searchResults.style.display = 'none';
                });
        }, 300);
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-box-klook')) {
            searchResults.style.display = 'none';
        }
    });

    searchInput.addEventListener('focus', function() {
        isUserInteracting = true;
        stopAutoSlide();
    });

    searchInput.addEventListener('blur', function() {
        setTimeout(() => {
            isUserInteracting = false;
            startAutoSlide();
        }, 1000);
    });

    function updateCityStyles() {
        cityItems.forEach((item, index) => {
            item.classList.remove('active', 'semi-active', 'distant');
            const diff = Math.abs(index - currentIndex);
            if (diff === 0) {
                item.classList.add('active');
            } else if (diff === 1) {
                item.classList.add('semi-active');
            } else {
                item.classList.add('distant');
            }
        });
    }

    function setActiveCity(newIndex) {
        if (currentIndex === newIndex) return;
        currentIndex = newIndex;
        
        const newBg = cityItems[currentIndex].getAttribute('data-bg');
        hero.style.backgroundImage = `url('${newBg}')`;
        
        updateCityStyles();
    }

    cityItems.forEach((item, index) => {
        item.addEventListener('click', () => {
            isUserInteracting = true;
            setActiveCity(index);
            resetAutoSlide();
        });
    });

    carousel.addEventListener('mouseenter', () => {
        isUserInteracting = true;
        stopAutoSlide();
    });

    carousel.addEventListener('mouseleave', () => {
        isUserInteracting = false;
        startAutoSlide();
    });

    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopAutoSlide();
        } else {
            if (!isUserInteracting) {
                startAutoSlide();
            }
        }
    });

    updateCityStyles();
    startAutoSlide();
}
</script>
{% endblock %}
